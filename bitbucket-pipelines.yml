# Bitbucket Pipeline: AI-Powered PR Review with Claude
# Automatically reviews Pull Requests using Anthropic's Claude API
#
# Configuration:
#   - Add ANTHROPIC_API_KEY to repository variables (secured)
#   - Add BITBUCKET_USERNAME and BITBUCKET_APP_PASSWORD for API access
#   - Optionally create .github/ai-review.yml for custom settings
#   - Use '[no-review]' prefix in PR title to skip reviews
#
# Required Repository Variables:
#   - ANTHROPIC_API_KEY: Your Anthropic API key (secured)
#   - BITBUCKET_USERNAME: Username for Bitbucket API authentication
#   - BITBUCKET_APP_PASSWORD: App password with PR read/write permissions (secured)

image: node:20

definitions:
  caches:
    npm-scripts: .github/scripts/node_modules
    ai-review-cache: .ai-review-cache

  steps:
    - step: &ai-review
        name: Claude Code Review
        caches:
          - npm-scripts
          - ai-review-cache
        script:
          # Skip if PR title starts with [no-review]
          - |
            if [[ "$BITBUCKET_PR_TITLE" == \[no-review\]* ]]; then
              echo "Skipping AI review - PR title indicates no review needed"
              exit 0
            fi

          # Install dependencies
          - cd .github/scripts && npm ci

          # Run tests to ensure code quality
          - npm test

          # Run the AI review
          - cd ../..
          - node .github/scripts/review-pr.js
        artifacts:
          - .ai-review-cache/**

pipelines:
  pull-requests:
    '**':
      - step:
          <<: *ai-review
          # Environment variables automatically available from Bitbucket:
          # - BITBUCKET_PR_ID
          # - BITBUCKET_PR_TITLE
          # - BITBUCKET_PR_DESCRIPTION (may be truncated)
          # - BITBUCKET_WORKSPACE
          # - BITBUCKET_REPO_SLUG
          # - BITBUCKET_COMMIT (head commit)
          # - BITBUCKET_PR_DESTINATION_BRANCH
          #
          # Additional variables from repository settings:
          # - ANTHROPIC_API_KEY (secured variable)
          # - BITBUCKET_USERNAME
          # - BITBUCKET_APP_PASSWORD (secured variable)

  custom:
    manual-review:
      - variables:
          - name: PR_NUMBER
            description: "PR number to review"
        step:
          <<: *ai-review
          name: Manual AI Code Review
          script:
            # Validate PR number is provided
            - |
              if [ -z "$PR_NUMBER" ]; then
                echo "ERROR: PR_NUMBER is required for manual review"
                exit 1
              fi

            # Set the PR ID for the adapter
            - export BITBUCKET_PR_ID="$PR_NUMBER"
            - export AI_REVIEW_TRIGGER="manual"

            # Install dependencies
            - cd .github/scripts && npm ci

            # Run tests
            - npm test

            # Run the AI review
            - cd ../..
            - node .github/scripts/review-pr.js
