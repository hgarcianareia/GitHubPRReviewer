# Bitbucket Pipelines: AI-Powered PR Review with Claude
# Automatically reviews Pull Requests using Anthropic's Claude API
#
# Configuration:
#   1. Create an API token at: Bitbucket Settings > Personal settings >
#      Atlassian account settings > Security > API tokens > Create API token with scopes
#      Required scopes:
#        - Repositories: Read
#        - Pull requests: Read and Write
#
#   2. Add these repository variables (Repository Settings > Repository variables):
#      - ANTHROPIC_API_KEY (secured) - Your Anthropic API key
#      - BITBUCKET_API_EMAIL (secured) - Your Atlassian account email
#      - BITBUCKET_API_TOKEN (secured) - The API token created in step 1
#
#   3. Optionally create .bitbucket/ai-review.yml for custom settings
#
#   4. Use 'skip-ai-review' in PR title to skip reviews
#
# Note: App Passwords are deprecated. Use API tokens with scopes instead.
# See: https://support.atlassian.com/bitbucket-cloud/docs/api-tokens/

image: node:20

definitions:
  caches:
    npm: ~/.npm

pipelines:
  pull-requests:
    '**':
      - step:
          name: AI PR Review
          caches:
            - npm
          script:
            # Install the AI review package
            - npm install @hgarcianareia/ai-pr-review-bitbucket@latest

            # Fetch PR data using Bitbucket API
            - |
              echo "Fetching PR #${BITBUCKET_PR_ID} data..."

              # Get PR diff
              curl -s -u "${BITBUCKET_API_EMAIL}:${BITBUCKET_API_TOKEN}" \
                "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_WORKSPACE}/${BITBUCKET_REPO_SLUG}/pullrequests/${BITBUCKET_PR_ID}/diff" \
                > pr_diff.txt

              # Get changed files
              curl -s -u "${BITBUCKET_API_EMAIL}:${BITBUCKET_API_TOKEN}" \
                "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_WORKSPACE}/${BITBUCKET_REPO_SLUG}/pullrequests/${BITBUCKET_PR_ID}/diffstat" \
                | jq -r '.values[].new.path // .values[].old.path' > changed_files.txt

              # Get existing comments
              curl -s -u "${BITBUCKET_API_EMAIL}:${BITBUCKET_API_TOKEN}" \
                "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_WORKSPACE}/${BITBUCKET_REPO_SLUG}/pullrequests/${BITBUCKET_PR_ID}/comments" \
                > pr_comments.json

            # Check for skip flag in PR title
            - |
              PR_TITLE=$(curl -s -u "${BITBUCKET_API_EMAIL}:${BITBUCKET_API_TOKEN}" \
                "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_WORKSPACE}/${BITBUCKET_REPO_SLUG}/pullrequests/${BITBUCKET_PR_ID}" \
                | jq -r '.title')

              if echo "$PR_TITLE" | grep -qi "skip-ai-review"; then
                echo "Skipping AI review (skip-ai-review found in PR title)"
                exit 0
              fi

            # Run the AI review
            - npx ai-pr-review-bitbucket

          artifacts:
            - pr_diff.txt
            - changed_files.txt
            - pr_comments.json
